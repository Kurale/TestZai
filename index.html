<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --primary: #4A90E2;
            --primary-dark: #357ABD;
            --accent: #FFD166;
            --success: #06D6A0;
            --error: #EF476F;
            --text: #2D3748;
            --bg: #F7FAFC;
            --card-bg: #FFFFFF;
            --radius: 16px;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        #app {
            width: 100%;
            max-width: 800px;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
        }

        .screen {
            display: none;
            padding: 40px;
            animation: fadeIn 0.5s ease;
        }
        .screen.active { display: block; }

        h1, h2, h3 { text-align: center; margin-bottom: 20px; color: var(--primary-dark); }
        p { line-height: 1.6; margin-bottom: 20px; text-align: center; }

        .btn {
            display: block;
            width: 100%;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            background-color: var(--primary);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }
        .btn:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        .btn:disabled { background-color: #CBD5E0; cursor: not-allowed; transform: none; }
        
        .btn-secondary {
            background-color: #718096;
            margin-top: 10px;
        }
        
        .btn-send {
            background-color: var(--success);
        }
        .btn-send:hover { background-color: #059669; }
        
        /* --- –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω (–ó–∞–≥—Ä—É–∑–∫–∞) --- */
        .input-group {
            background: #F8FAFC;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px dashed #E2E8F0;
            text-align: left;
        }
        
        label { display: block; font-weight: 700; margin-bottom: 8px; color: #4A5568; }
        
        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            outline: none;
        }
        input[type="text"]:focus { border-color: var(--primary); }

        .error-msg {
            color: var(--error);
            font-weight: 700;
            margin-top: 10px;
            display: none;
        }

        /* --- –¢–µ—Å—Ç --- */
        .header-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-weight: 600;
            color: #718096;
        }
        .progress-container {
            height: 10px; background-color: #E2E8F0; border-radius: 5px; margin-bottom: 30px; overflow: hidden;
        }
        .progress-bar { height: 100%; background-color: var(--accent); width: 0%; transition: width 0.4s ease; }
        .question-text { font-size: 1.4rem; font-weight: 700; margin-bottom: 30px; text-align: center; }
        
        .question-image {
            max-width: 100%;
            height: auto;
            margin: 0 auto 20px auto;
            display: block;
            border-radius: 8px;
            border: 1px solid #E2E8F0;
        }
        
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .option-card {
            background: #F8FAFC; border: 2px solid #E2E8F0; padding: 15px 20px; border-radius: 12px;
            cursor: pointer; transition: all 0.2s; text-align: center;
        }
        .option-card:hover { border-color: var(--primary); background: #EBF8FF; }
        .option-card.selected { border-color: var(--primary); background-color: #BEE3F8; color: var(--primary-dark); }
        
        .matching-container { display: flex; justify-content: space-between; gap: 20px; }
        .matching-column { display: flex; flex-direction: column; gap: 10px; width: 48%; }
        .match-item {
            background: #F8FAFC; border: 2px solid #E2E8F0; padding: 10px; border-radius: 8px;
            cursor: pointer; text-align: center; transition: all 0.2s;
        }
        .match-item.active { border-color: var(--accent); background: #FFFAE6; transform: scale(1.02); }
        .match-item.matched { border-color: var(--success); background: #E6FFFA; opacity: 0.6; cursor: default; }

        .feedback-area {
            margin-top: 20px; padding: 15px; border-radius: 12px; text-align: center; font-weight: 600;
            display: none; animation: slideUp 0.3s ease;
        }
        .feedback-area.success { background-color: #E6FFFA; color: #047857; display: block; }
        .feedback-area.error { background-color: #FFF5F5; color: #C53030; display: block; }

        /* --- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: #F8FAFC; padding: 15px; border-radius: 12px; text-align: center; }
        .stat-value { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 0.9rem; color: #718096; }
        .chart-container { position: relative; height: 200px; width: 100%; margin-bottom: 30px; }
        .error-list { list-style: none; text-align: left; max-height: 200px; overflow-y: auto; border: 1px solid #E2E8F0; border-radius: 8px; padding: 10px; }
        .error-item { background: #FFF5F5; padding: 10px; margin-bottom: 8px; border-radius: 6px; font-size: 0.9rem; }
        .error-item strong { display: block; color: #C53030; margin-bottom: 4px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake { animation: shake 0.3s ease-in-out; }

        @media (max-width: 600px) {
            .screen { padding: 20px; }
            .matching-container { flex-direction: column; gap: 10px; }
            .matching-column { width: 100%; }
        }
    </style>
</head>
<body>

<div id="app">
    <!-- 1. –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω (–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞) -->
    <div id="start-screen" class="screen active">
        <h1>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¢–µ—Å—Ç–æ–≤</h1>
        <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å —Ç–µ—Å—Ç–∞–º–∏, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.</p>

        <!-- –í–≤–æ–¥ –∏–º–µ–Ω–∏ —É—á–µ–Ω–∏–∫–∞ -->
        <div class="input-group">
            <label for="student-name-input">–í–∞—à–µ –∏–º—è:</label>
            <input type="text" id="student-name-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
            <small style="color:#718096; display:block; margin-top:5px;">–ò–º—è –±—É–¥–µ—Ç —É–∫–∞–∑–∞–Ω–æ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö —Ç–µ—Å—Ç–∞</small>
        </div>

        <!-- –°–ø–æ—Å–æ–± 1: –£–∫–∞–∑–∞—Ç—å –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è fetch -->
        <div class="input-group">
            <label for="filename-input">–ò–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è):</label>
            <input type="text" id="filename-input" placeholder="–ò–º—è —Ñ–∞–π–ª–∞">
            <small style="color:#718096; display:block; margin-top:5px;">–§–∞–π–ª –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∏–∑ –ø–∞–ø–∫–∏ Data/ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .json</small>
        </div>

        <button class="btn" onclick="app.loadFromServer()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞</button>

        <!-- <div style="text-align: center; margin: 20px 0; color: #CBD5E0;">‚Äî –ò–õ–ò ‚Äî</div> –ó–ê–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–ù–û –î–õ–Ø –ü–†–û–î–ê–ö–®–ï–ù–ê -->

        <!-- –°–ø–æ—Å–æ–± 2: –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (File API) -->
        <!-- –ó–ê–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–ù–û –î–õ–Ø –ü–†–û–î–ê–ö–®–ï–ù–ê -->
        <!--
        <div class="input-group">
            <label for="file-upload">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:</label>
            <input type="file" id="file-upload" accept=".json">
            <small style="color:#718096; display:block; margin-top:5px;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ, –µ—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ HTML —Ñ–∞–π–ª –¥–≤–æ–π–Ω—ã–º –∫–ª–∏–∫–æ–º.</small>
        </div>

        <button class="btn btn-secondary" onclick="app.loadFromFileInput()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª</button>
        -->

        <div id="start-error" class="error-msg"></div>
    </div>

    <!-- 2. –≠–∫—Ä–∞–Ω –≤–æ–ø—Ä–æ—Å–∞ -->
    <div id="quiz-screen" class="screen">
        <div class="header-info">
            <span id="timer-total">‚è± 00:00</span>
            <span id="question-counter">–í–æ–ø—Ä–æ—Å 1 –∏–∑ --</span>
        </div>
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        <h2 id="question-title" class="question-text">...</h2>
        <div id="answers-area"></div>
        <div id="feedback" class="feedback-area"></div>
        <button id="next-btn" class="btn" onclick="app.nextQuestion()" disabled>–û—Ç–≤–µ—Ç–∏—Ç—å</button>
    </div>

    <!-- 3. –≠–∫—Ä–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
    <div id="result-screen" class="screen">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="res-score">0%</div>
                <div class="stat-label">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="res-correct">0</div>
                <div class="stat-label">–ü—Ä–∞–≤–∏–ª—å–Ω–æ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="res-time">00:00</div>
                <div class="stat-label">–í—Ä–µ–º—è</div>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="resultsChart"></canvas>
        </div>
        <h3>–†–∞–∑–±–æ—Ä –æ—à–∏–±–æ–∫</h3>
        <ul id="error-list" class="error-list"></ul>
        <p id="no-errors-msg" style="display:none; color: var(--success);">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –û—à–∏–±–æ–∫ –Ω–µ—Ç üéâ</p>
        
        <button class="btn btn-send" onclick="app.sendToTelegram()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
        <button class="btn btn-secondary" onclick="location.reload()">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
    </div>
</div>

<script>
    class QuizApp {
        constructor() {
            this.data = [];
            this.currentIndex = 0;
            this.userAnswers = [];
            this.totalStartTime = 0;
            this.questionStartTime = 0;
            this.timerInterval = null;
            this.selectedMatchLeft = null;
            this.currentMatches = {};
            this.currentSelection = null; // –î–ª—è single choice
            this.resultData = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∞
            this.chartInstance = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –≥—Ä–∞—Ñ–∏–∫–∞
            this.testTopic = ""; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–º—ã —Ç–µ—Å—Ç–∞ –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
            
            this.screens = {
                start: document.getElementById('start-screen'),
                quiz: document.getElementById('quiz-screen'),
                result: document.getElementById('result-screen')
            };
            
            this.elements = {
                timerTotal: document.getElementById('timer-total'),
                counter: document.getElementById('question-counter'),
                progressBar: document.getElementById('progress-bar'),
                questionTitle: document.getElementById('question-title'),
                answersArea: document.getElementById('answers-area'),
                nextBtn: document.getElementById('next-btn'),
                feedback: document.getElementById('feedback'),
                startError: document.getElementById('start-error'),
                filenameInput: document.getElementById('filename-input'),
                studentNameInput: document.getElementById('student-name-input'),
                // fileInput: document.getElementById('file-upload') // –ó–ê–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–ù–û –î–õ–Ø –ü–†–û–î–ê–ö–®–ï–ù–ê
            };

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –∏–º–µ–Ω–∏ —É—á–µ–Ω–∏–∫–∞
            const savedName = localStorage.getItem("studentName");
            if (savedName) {
                this.elements.studentNameInput.value = savedName;
            }
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
            this.elements.studentNameInput.addEventListener('input', (e) => {
                const name = e.target.value.trim();
                if (name) {
                    localStorage.setItem("studentName", name);
                }
            });

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ (–∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)
            const urlParams = new URLSearchParams(window.location.search);
            const fileParam = urlParams.get('file');
            if (fileParam) {
                // –£–±–∏—Ä–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ .json, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
                const cleanName = fileParam.replace(/\.json$/i, '');
                this.elements.filenameInput.value = cleanName;
                this.loadFromServer();
            }
        }

        // --- –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ ---
        validateFilename(filename) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–º—è –Ω–µ –ø—É—Å—Ç–æ–µ
            if (!filename || filename.trim() === '') {
                return { valid: false, message: "–û—à–∏–±–∫–∞: –ò–º—è —Ñ–∞–π–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º" };
            }
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)
            if (filename.includes('..') || filename.includes('\\') || filename.includes('/') || filename.includes('.json')) {
                return { valid: false, message: "–û—à–∏–±–∫–∞: –ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞" };
            }
            return { valid: true };
        }

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ Fetch (–°–µ—Ä–≤–µ—Ä) ---
        async loadFromServer() {
            const filename = this.elements.filenameInput.value.trim();
            const validation = this.validateFilename(filename);
            
            if (!validation.valid) {
                this.showError(validation.message);
                return;
            }

            // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∫–∞–∫ —Ç–µ–º—É —Ç–µ—Å—Ç–∞ ---
            this.testTopic = filename;
            // ---------------------------------------------------

            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å: Data/–∏–º—è_—Ñ–∞–π–ª–∞.json
            const fullPath = `Data/${filename}.json`;

            this.elements.startError.style.display = 'none';
            this.elements.startError.textContent = '';
            
            try {
                const btn = document.querySelector('#start-screen .btn');
                btn.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
                btn.disabled = true;

                const response = await fetch(fullPath);
                
                if (!response.ok) {
                    throw new Error(`–§–∞–π–ª '${fullPath}' –Ω–µ –Ω–∞–π–¥–µ–Ω (–û—à–∏–±–∫–∞ ${response.status}).`);
                }

                const data = await response.json();
                this.initQuiz(data);

            } catch (error) {
                console.error(error);
                this.showError(error.message);
            } finally {
                const btn = document.querySelector('#start-screen .btn');
                btn.textContent = "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞";
                btn.disabled = false;
            }
        }

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ File API (–õ–æ–∫–∞–ª—å–Ω–æ) ---
        // –ó–ê–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–ù–û –î–õ–Ø –ü–†–û–î–ê–ö–®–ï–ù–ê
        /*
        loadFromFileInput() {
            const fileInput = this.elements.fileInput;
            const file = fileInput.files[0];

            if (!file) {
                this.showError("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.");
                return;
            }

            const filename = file.name;
            const validation = this.validateFilename(filename);
            if (!validation.valid) {
                this.showError(validation.message);
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    this.initQuiz(data);
                } catch (err) {
                    this.showError("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è JSON: —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.");
                }
            };
            reader.readAsText(file);
        }
        */

        showError(msg) {
            this.elements.startError.innerHTML = msg;
            this.elements.startError.style.display = 'block';
            // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –æ—à–∏–±–∫–∏
            this.screens.start.classList.add('shake');
            setTimeout(() => this.screens.start.classList.remove('shake'), 500);
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö ---
        initQuiz(data) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
            if (!Array.isArray(data) || data.length === 0) {
                this.showError("–û—à–∏–±–∫–∞: JSON —Ñ–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º –≤–æ–ø—Ä–æ—Å–æ–≤.");
                return;
            }

            this.data = data;
            this.currentIndex = 0;
            this.userAnswers = [];
            this.totalStartTime = Date.now();
            
            this.switchScreen('quiz');
            this.startGlobalTimer();
            this.loadQuestion();
        }

        switchScreen(screenName) {
            Object.values(this.screens).forEach(el => el.classList.remove('active'));
            this.screens[screenName].classList.add('active');
        }

        startGlobalTimer() {
            this.timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - this.totalStartTime) / 1000);
                this.elements.timerTotal.textContent = `‚è± ${this.formatTime(elapsed)}`;
            }, 1000);
        }

        formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        loadQuestion() {
            const question = this.data[this.currentIndex];
            this.questionStartTime = Date.now();
            this.elements.nextBtn.disabled = true;
            this.elements.nextBtn.textContent = "–û—Ç–≤–µ—Ç–∏—Ç—å";
            this.elements.feedback.className = 'feedback-area';
            this.elements.feedback.style.display = 'none';
            this.selectedMatchLeft = null;
            this.currentMatches = {};
            this.currentSelection = null;

            this.elements.counter.textContent = `–í–æ–ø—Ä–æ—Å ${this.currentIndex + 1} –∏–∑ ${this.data.length}`;
            const progress = (this.currentIndex / this.data.length) * 100;
            this.elements.progressBar.style.width = `${progress}%`;

            // –û—á–∏—Å—Ç–∫–∞ –æ–±–ª–∞—Å—Ç–∏ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
            this.elements.answersArea.innerHTML = '';
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å
            if (question.image_url) {
                const img = document.createElement('img');
                img.src = question.image_url;
                img.className = 'question-image';
                img.alt = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫ –≤–æ–ø—Ä–æ—Å—É';
                img.onerror = () => {
                    img.style.display = 'none';
                    console.warn(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: ${question.image_url}`);
                };
                this.elements.answersArea.appendChild(img);
            }

            const text = question.question_text || question.statement || question.question;
            this.elements.questionTitle.textContent = text;

            switch (question.type) {
                case 'fill_blank':
                case 'short_answer':
                    this.renderTextInput(question);
                    break;
                case 'multiple_choice':
                    this.renderMultipleChoice(question);
                    break;
                case 'true_false':
                    this.renderTrueFalse(question);
                    break;
                case 'matching':
                    this.renderMatching(question);
                    break;
                default:
                    this.elements.answersArea.innerHTML = '<p style="color:red">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞</p>';
            }
        }

        renderTextInput(q) {
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç...';
            input.oninput = () => { this.elements.nextBtn.disabled = false; };
            setTimeout(() => input.focus(), 100);
            this.elements.answersArea.appendChild(input);
        }

        renderMultipleChoice(q) {
            const grid = document.createElement('div');
            grid.className = 'options-grid';
            q.options.forEach(opt => {
                const card = document.createElement('div');
                card.className = 'option-card';
                card.textContent = opt;
                card.onclick = () => {
                    document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    this.elements.nextBtn.disabled = false;
                    this.currentSelection = opt;
                };
                grid.appendChild(card);
            });
            this.elements.answersArea.appendChild(grid);
        }

        renderTrueFalse(q) {
            const grid = document.createElement('div');
            grid.className = 'options-grid';
            const opts = [
                { label: '–í–µ—Ä–Ω–æ', value: true, icon: '‚úÖ' },
                { label: '–ù–µ–≤–µ—Ä–Ω–æ', value: false, icon: '‚ùå' }
            ];
            opts.forEach(opt => {
                const card = document.createElement('div');
                card.className = 'option-card';
                card.innerHTML = `<span style="font-size:1.5rem; margin-right:10px;">${opt.icon}</span> ${opt.label}`;
                card.onclick = () => {
                    document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    this.elements.nextBtn.disabled = false;
                    this.currentSelection = opt.value;
                };
                grid.appendChild(card);
            });
            this.elements.answersArea.appendChild(grid);
        }

        renderMatching(q) {
            const container = document.createElement('div');
            container.className = 'matching-container';
            const leftCol = document.createElement('div');
            leftCol.className = 'matching-column';
            const rightCol = document.createElement('div');
            rightCol.className = 'matching-column';

            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –ø—Ä–∞–≤—É—é –∫–æ–ª–æ–Ω–∫—É
            const rightOptions = [...q.pairs.map(p => p.right)];
            this.shuffleArray(rightOptions);

            q.pairs.forEach(pair => {
                const btnL = document.createElement('div');
                btnL.className = 'match-item';
                btnL.textContent = pair.left;
                btnL.dataset.left = pair.left;
                btnL.onclick = () => this.handleMatchClick(btnL, 'left');
                leftCol.appendChild(btnL);
            });

            rightOptions.forEach(text => {
                const btnR = document.createElement('div');
                btnR.className = 'match-item';
                btnR.textContent = text;
                btnR.dataset.right = text;
                btnR.onclick = () => this.handleMatchClick(btnR, 'right');
                rightCol.appendChild(btnR);
            });

            container.appendChild(leftCol);
            container.appendChild(rightCol);
            this.elements.answersArea.appendChild(container);
        }

        handleMatchClick(el, side) {
            if (el.classList.contains('matched')) return;
            if (side === 'left') {
                document.querySelectorAll('.match-item[data-left]').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
                this.selectedMatchLeft = el.dataset.left;
            } else if (side === 'right') {
                if (!this.selectedMatchLeft) return;
                this.currentMatches[this.selectedMatchLeft] = el.dataset.right;
                const leftEl = document.querySelector(`.match-item[data-left="${this.selectedMatchLeft}"]`);
                leftEl.classList.remove('active');
                leftEl.classList.add('matched');
                el.classList.add('matched');
                this.selectedMatchLeft = null;
                if (Object.keys(this.currentMatches).length === this.data[this.currentIndex].pairs.length) {
                    this.elements.nextBtn.disabled = false;
                }
            }
        }

        shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        nextQuestion() {
            if (this.elements.nextBtn.textContent === '–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å') {
                this.currentIndex++;
                if (this.currentIndex < this.data.length) {
                    this.loadQuestion();
                } else {
                    this.finishQuiz();
                }
                return;
            }
            this.validateAnswer();
        }

        validateAnswer() {
            const q = this.data[this.currentIndex];
            let isCorrect = false;
            let userAnswerStr = "";

            if (q.type === 'multiple_choice') {
                userAnswerStr = this.currentSelection;
                isCorrect = (userAnswerStr === q.correct_answer);
            } else if (q.type === 'true_false') {
                userAnswerStr = this.currentSelection;
                isCorrect = (userAnswerStr === q.correct_answer);
            } else if (q.type === 'fill_blank' || q.type === 'short_answer') {
                const input = this.elements.answersArea.querySelector('input');
                userAnswerStr = input.value.trim();
                const correctStr = q.correct_answer.trim();
                if (q.case_sensitive) {
                    isCorrect = (userAnswerStr === correctStr);
                } else {
                    isCorrect = (userAnswerStr.toLowerCase() === correctStr.toLowerCase());
                }
            } else if (q.type === 'matching') {
                let allCorrect = true;
                q.pairs.forEach(pair => {
                    if (this.currentMatches[pair.left] !== pair.right) allCorrect = false;
                });
                isCorrect = allCorrect;
            }

            const timeSpent = Math.floor((Date.now() - this.questionStartTime) / 1000);
            this.userAnswers.push({
                question: q.question_text || q.statement || q.question,
                isCorrect: isCorrect,
                explanation: q.explanation,
                time: timeSpent
            });

            this.showFeedback(isCorrect, q.explanation);
        }

        showFeedback(isCorrect, explanation) {
            const fb = this.elements.feedback;
            fb.style.display = 'block';
            fb.className = 'feedback-area';
            if (isCorrect) {
                fb.classList.add('success');
                fb.textContent = "–ü—Ä–∞–≤–∏–ª—å–Ω–æ! –ú–æ–ª–æ–¥–µ—Ü! üåü";
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            } else {
                fb.classList.add('error');
                fb.textContent = "–ù–µ–≤–µ—Ä–Ω–æ. " + explanation;
                this.screens.quiz.classList.add('shake');
                setTimeout(() => this.screens.quiz.classList.remove('shake'), 500);
            }
            this.disableInputs();
            this.elements.nextBtn.textContent = "–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å";
            this.elements.nextBtn.disabled = false;
        }

        disableInputs() {
            const inputs = this.elements.answersArea.querySelectorAll('input, .option-card, .match-item');
            inputs.forEach(el => {
                if (el.tagName === 'INPUT') el.disabled = true;
                else el.style.pointerEvents = 'none';
            });
        }

finishQuiz() {
  clearInterval(this.timerInterval);
  this.switchScreen('result');
  this.calculateResults();
}

        calculateResults() {
            const total = this.userAnswers.length;
            const correct = this.userAnswers.filter(a => a.isCorrect).length;
            const percent = Math.round((correct / total) * 100);
            const totalTime = Math.floor((Date.now() - this.totalStartTime) / 1000);
            const studentName = this.elements.studentNameInput.value.trim() || '–ê–Ω–æ–Ω–∏–º';

            // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é —Ç–µ–º—É –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ ---
            this.resultData = {
                name: studentName,
                correct: correct,
                total: total,
                percent: percent,
                time: this.formatTime(totalTime),
                topic: this.testTopic || "–û–±—â–∏–π —Ç–µ—Å—Ç" // –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –ø—É—Å—Ç–æ, —Å—Ç–∞–≤–∏–º –∑–∞–≥–ª—É—à–∫—É
            };
            // -------------------------------------------------------------

            document.getElementById('res-score').textContent = `${percent}%`;
            document.getElementById('res-correct').textContent = `${correct} / ${total}`;
            document.getElementById('res-time').textContent = this.formatTime(totalTime);

            const scoreEl = document.getElementById('res-score');
            scoreEl.style.color = percent >= 70 ? 'var(--success)' : (percent >= 40 ? 'var(--accent)' : 'var(--error)');

            const errorList = document.getElementById('error-list');
            const noErrorsMsg = document.getElementById('no-errors-msg');
            errorList.innerHTML = '';
            const mistakes = this.userAnswers.filter(a => !a.isCorrect);

            if (mistakes.length === 0) {
                noErrorsMsg.style.display = 'block';
                confetti({ particleCount: 200, spread: 100 });
            } else {
                noErrorsMsg.style.display = 'none';
                mistakes.forEach(m => {
                    const li = document.createElement('li');
                    li.className = 'error-item';
                    li.innerHTML = `<strong>–û—à–∏–±–∫–∞</strong>${m.question}<br><em>${m.explanation}</em>`;
                    errorList.appendChild(li);
                });
            }

            const ctx = document.getElementById('resultsChart').getContext('2d');
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –æ–Ω –±—ã–ª, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–ª–∏—Å—å (—Ö–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞)
            if (this.chartInstance) {
                this.chartInstance.destroy();
            }
            this.chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['–ü—Ä–∞–≤–∏–ª—å–Ω–æ', '–û—à–∏–±–∫–∏'],
                    datasets: [{
                        data: [correct, total - correct],
                        backgroundColor: ['#06D6A0', '#EF476F'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

sendToTelegram() {
    if (!this.resultData) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏');
        return;
    }

    console.log('üì§ –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', this.resultData);

    const btn = document.querySelector('#result-screen .btn-send');
    const originalText = btn.textContent;
    btn.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";
    btn.disabled = true;

    // --- –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–π URL —Å–∫—Ä–∏–ø—Ç–∞ ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxeEK0VPCu1Bh72GyMFE9z95MTWw91K1DHJsBeDKeqwCw-ZCsWbZ0PHiD4gQmInn3mr/exec"; 
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    const params = new URLSearchParams({
        student: this.resultData.name,
        correct: this.resultData.correct,
        total: this.resultData.total,
        percent: this.resultData.percent,
        time: this.resultData.time,
        topic: this.resultData.topic
    });
    
    const finalUrl = `${SCRIPT_URL}?${params.toString()}`;
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º fetch —Å mode: 'no-cors'
    // –ü–æ—è—Å–Ω–µ–Ω–∏–µ: –ë—Ä–∞—É–∑–µ—Ä—ã –±–ª–æ–∫–∏—Ä—É—é—Ç —á—Ç–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Google Script –∏–∑-–∑–∞ CORS –ø–æ–ª–∏—Ç–∏–∫,
    // –µ—Å–ª–∏ –º—ã –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º HTML —Ñ–∞–π–ª. 'no-cors' –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ,
    // –Ω–æ –º—ã –Ω–µ —É–∑–Ω–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ (200 –∏–ª–∏ 404). –ú—ã –ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –≤—Å–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ.
    fetch(finalUrl, {
        method: "GET",
        mode: "no-cors" 
    })
    .then(() => {
        console.log('‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (no-cors)');
        alert(`‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!\n–£—á–µ–Ω–∏–∫: ${this.resultData.name}\n–¢–µ—Å—Ç: ${this.resultData.topic}`);
        btn.textContent = "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ";
    })
    .catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
        btn.textContent = originalText;
        btn.disabled = false;
    });
}
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const app = new QuizApp();
</script>
</body>
</html>